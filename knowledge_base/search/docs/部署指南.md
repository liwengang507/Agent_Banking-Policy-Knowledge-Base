# 部署指南

## 环境要求

### 系统要求
- **操作系统**: Windows 10/11, macOS 10.14+, Ubuntu 18.04+
- **Python版本**: Python 3.7 或更高版本
- **内存**: 最少 4GB RAM，推荐 8GB 或更多
- **存储**: 至少 2GB 可用空间
- **网络**: 稳定的互联网连接（用于下载依赖包）

### 软件依赖
- Python 3.7+
- pip (Python包管理器)
- Git (版本控制)

## 快速部署

### 1. 克隆项目
```bash
git clone https://github.com/your-username/bank-policy-rag-system.git
cd bank-policy-rag-system
```

### 2. 创建虚拟环境
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

### 3. 安装依赖
```bash
pip install -r requirements.txt
```

### 4. 启动系统
```bash
python 启动RAG.py
```

## 详细部署步骤

### Windows 部署

#### 1. 环境准备
```powershell
# 检查Python版本
python --version

# 升级pip
python -m pip install --upgrade pip

# 安装虚拟环境工具
pip install virtualenv
```

#### 2. 项目设置
```powershell
# 创建项目目录
mkdir bank-policy-rag-system
cd bank-policy-rag-system

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

#### 3. 配置系统
```powershell
# 创建配置文件
copy config\config.example.json config\config.json

# 编辑配置文件
notepad config\config.json
```

#### 4. 启动服务
```powershell
# 启动系统
python 启动RAG.py

# 或者使用批处理文件
启动RAG.bat
```

### Linux/macOS 部署

#### 1. 环境准备
```bash
# 更新系统包
sudo apt update  # Ubuntu/Debian
# 或
brew update      # macOS

# 安装Python和pip
sudo apt install python3 python3-pip  # Ubuntu/Debian
# 或
brew install python3  # macOS
```

#### 2. 项目设置
```bash
# 创建项目目录
mkdir -p ~/bank-policy-rag-system
cd ~/bank-policy-rag-system

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 3. 配置系统
```bash
# 创建配置文件
cp config/config.example.json config/config.json

# 编辑配置文件
nano config/config.json
```

#### 4. 启动服务
```bash
# 启动系统
python 启动RAG.py

# 后台运行
nohup python 启动RAG.py > app.log 2>&1 &
```

## Docker 部署

### 1. 创建 Dockerfile
```dockerfile
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8501

# 启动命令
CMD ["python", "启动RAG.py"]
```

### 2. 构建和运行
```bash
# 构建镜像
docker build -t bank-policy-rag .

# 运行容器
docker run -p 8501:8501 bank-policy-rag

# 后台运行
docker run -d -p 8501:8501 --name rag-system bank-policy-rag
```

### 3. Docker Compose 部署
```yaml
version: '3.8'

services:
  rag-system:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - ./knowledge_base:/app/knowledge_base
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
    restart: unless-stopped
```

## 生产环境部署

### 1. 使用 Nginx 反向代理
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 2. 使用 Gunicorn 部署
```bash
# 安装 Gunicorn
pip install gunicorn

# 启动服务
gunicorn --bind 0.0.0.0:8501 --workers 4 --timeout 120 启动RAG:app
```

### 3. 使用 systemd 管理服务
```ini
[Unit]
Description=Bank Policy RAG System
After=network.target

[Service]
Type=simple
User=rag-user
WorkingDirectory=/opt/bank-policy-rag-system
Environment=PATH=/opt/bank-policy-rag-system/venv/bin
ExecStart=/opt/bank-policy-rag-system/venv/bin/python 启动RAG.py
Restart=always

[Install]
WantedBy=multi-user.target
```

## 云平台部署

### 1. AWS 部署
```bash
# 使用 AWS CLI
aws ec2 run-instances \
    --image-id ami-0c55b159cbfafe1d0 \
    --instance-type t3.medium \
    --key-name your-key-pair \
    --security-group-ids sg-xxxxxxxxx \
    --subnet-id subnet-xxxxxxxxx
```

### 2. Azure 部署
```bash
# 使用 Azure CLI
az vm create \
    --resource-group myResourceGroup \
    --name rag-vm \
    --image UbuntuLTS \
    --admin-username azureuser \
    --generate-ssh-keys
```

### 3. Google Cloud 部署
```bash
# 使用 gcloud CLI
gcloud compute instances create rag-instance \
    --image-family ubuntu-1804-lts \
    --image-project ubuntu-os-cloud \
    --machine-type n1-standard-2
```

## 监控和维护

### 1. 日志管理
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
grep ERROR logs/app.log

# 日志轮转配置
logrotate -f /etc/logrotate.d/rag-system
```

### 2. 性能监控
```bash
# 监控系统资源
htop

# 监控网络连接
netstat -tulpn | grep :8501

# 监控应用状态
ps aux | grep python
```

### 3. 备份策略
```bash
# 备份知识库
tar -czf knowledge_base_backup_$(date +%Y%m%d).tar.gz knowledge_base/

# 备份配置文件
cp -r config/ backup/config_$(date +%Y%m%d)/

# 自动备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf /backup/rag_system_$DATE.tar.gz /opt/bank-policy-rag-system/
```

## 故障排除

### 常见问题

#### 1. 端口被占用
```bash
# 查看端口占用
netstat -tulpn | grep :8501

# 杀死占用进程
kill -9 <PID>

# 或使用不同端口
python 启动RAG.py --server.port 8502
```

#### 2. 依赖包安装失败
```bash
# 升级pip
pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/

# 清理缓存
pip cache purge
```

#### 3. 内存不足
```bash
# 增加虚拟内存
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 性能优化

#### 1. 系统优化
```bash
# 调整文件描述符限制
ulimit -n 65536

# 优化网络参数
echo 'net.core.somaxconn = 65535' >> /etc/sysctl.conf
sysctl -p
```

#### 2. 应用优化
```python
# 启用缓存
CACHE_ENABLED = True
CACHE_SIZE = 1000

# 调整工作线程数
WORKER_THREADS = 4

# 启用压缩
COMPRESS_RESPONSE = True
```

## 安全配置

### 1. 防火墙设置
```bash
# Ubuntu/Debian
sudo ufw allow 8501
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8501/tcp
sudo firewall-cmd --reload
```

### 2. SSL 证书配置
```bash
# 使用 Let's Encrypt
sudo apt install certbot
sudo certbot --nginx -d your-domain.com
```

### 3. 访问控制
```python
# 配置访问控制
ALLOWED_IPS = ['192.168.1.0/24', '10.0.0.0/8']
RATE_LIMIT = 100  # 每分钟请求数限制
```

## 更新和维护

### 1. 系统更新
```bash
# 更新依赖包
pip install --upgrade -r requirements.txt

# 更新应用代码
git pull origin main

# 重启服务
sudo systemctl restart rag-system
```

### 2. 数据维护
```bash
# 重建索引
python rebuild_index.py

# 清理缓存
python clear_cache.py

# 数据验证
python validate_data.py
```

### 3. 监控告警
```python
# 配置监控告警
ALERT_EMAIL = "admin@example.com"
ALERT_THRESHOLD = 0.9  # 错误率阈值
MONITOR_INTERVAL = 60  # 监控间隔（秒）
```
